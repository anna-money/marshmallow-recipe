name: CI
on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    branches: [main]
env:
  RUSTUP_INIT: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        python-version: ['3.12', '3.13', '3.14']
        marshmallow:
          - marshmallow==2.20.5
          - marshmallow[reco]==2.20.5
          - marshmallow>=2,<3
          - marshmallow[reco]>=2,<3
          - marshmallow>=3,<4
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: ${{ env.RUSTUP_INIT }} && echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - run: echo ${{ matrix.python-version }} > .python-version
      - run: make deps
      - run: uv pip install '${{ matrix.marshmallow }}'
      - run: make lint
      - run: make test
  build:
    needs: [test]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-14, macos-15]
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: ${{ env.RUSTUP_INIT }} && echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - run: echo 3.12 > .python-version
      - name: Set version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          sed -i.bak "s/^version = .*/version = \"$VERSION\"/" Cargo.toml && rm Cargo.toml.bak
      - run: make build-wheel
      - uses: actions/upload-artifact@v4
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          name: wheel-${{ matrix.os }}
          path: dist/*.whl
  sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: ${{ env.RUSTUP_INIT }} && echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Set version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml
      - run: make build-sdist
      - uses: actions/upload-artifact@v4
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          name: sdist
          path: dist/*.tar.gz
  publish:
    needs: [test, build, sdist]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: astral-sh/setup-uv@v5
      - uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          path: dist
          merge-multiple: true
      - uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist
      - run: uv publish dist/*
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
